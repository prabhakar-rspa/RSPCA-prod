<aura:component
  controller="BulkRenewController"
  implements="flexipage:availableForAllPageTypes,flexipage:availableForRecordHome,force:hasRecordId,forceCommunity:availableForAllPageTypes,force:lightningQuickActionWithoutHeader"
  access="global"
>
  <!-- Contact Record -->
  <aura:attribute name="primaryContact" type="Object" />
  <aura:attribute name="fullname" type="string" />

  <!-- Payment Method and Signed Fields -->
  <aura:attribute name="payMethod" type="String" />
  <aura:attribute name="payMethodValues" type="Object" />
  <c:LightningPicklist
    sObjectName="Application__c"
    fieldName="Payment_Method__c"
    picklistValues="{!v.payMethodValues}"
  />
  <aura:attribute name="agreement" type="boolean" />
  <aura:attribute name="noOffences" type="boolean" />
  <aura:attribute name="agreementDate" type="date" />
  <aura:attribute name="poNumber" type="String"/>

  <!-- IsLoading boolean -->
  <aura:attribute name="isLoading" type="boolean" default="true" />

  <!-- Site Records -->
  <aura:attribute name="siteList" type="List" />
  <aura:attribute name="emptyListSize" type="boolean" default="false"/>

  <!-- Selected Sites -->
  <aura:attribute name="selectedSiteId" type="String[]" />

  <!-- Steps check -->
  <aura:attribute name="currentStep" type="string" default="1" />
  <aura:attribute name="step1" type="boolean" default="true" />
  <aura:attribute name="step2" type="boolean" default="false" />
  <aura:attribute name="hasError" type="boolean" default="false" />

  <!-- Accordian Attributes -->
  <aura:attribute name="activeSections" type="List" />
  <aura:attribute name="activeSectionsMessage" type="String" default="" />

  <!-- Bulk Renewal Record Or Payment Record-->
  <aura:attribute name="submitResponse" type="Object" />

  <!-- Initialise the component -->
  <aura:handler name="init" value="{!this}" action="{!c.doInit}" />

  <!-- Modal Header -->
  <header class="slds-modal__header">
    <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate"
      >Renew Sites</h2
    >
  </header>

  <!-- Modal Content -->
  <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
    <!-- Scrolling -->
    <ui:scrollerWrapper class="bulkRenewalScroller" >
      <!-- Step 1 -->
      <aura:if isTrue="{!v.step1}">
        <aura:if isTrue="{!v.isLoading}">
          <div class="exampleHolder">
            <lightning:spinner alternativeText="Loading" size="medium" />
          </div>
          <div
            class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_offline"
            role="alert"
          >
            <span class="slds-assistive-text">loading message</span>
            <h2>
              Application Loading. If it doesn't, close this window and try again
              or refresh your browser and try again.
            </h2>
          </div>

          <aura:set attribute="else">
            <aura:if isTrue="{!v.primaryContact != null}">
              <div class="slds-form">
                <aura:if isTrue="{!v.emptyListSize == true}">
                  <p style="color: red;"><strong>No sites available to renew</strong> </p><br/>
                </aura:if>
                <h3 class="slds-section__title slds-theme_shade">
                  Sites
                </h3>
                <p>Please select the sites you wish to renew memberships for. Expand the sections to view the units that will be renewed.</p>
                <!-- list of sites -->
                <div class="slds-m-around_x-small">

                  <!-- Select All Sites checkbox -->
                  <lightning:button label="Select All Sites" title="Select All Sites" onclick="{! c.selectAllSites }"/>

                  <!-- Deslect All Sites checkbox -->
                  <lightning:button label="Deselect All Sites" title="Deselect All Sites" onclick="{! c.deselectAllSites }"/>
                  
                  <!-- Lightning Accordian Start-->
                  <p>{! v.activeSectionsMessage }</p>
                  <lightning:accordion
                      allowMultipleSectionsOpen="true"
                      onsectiontoggle="{! c.handleSectionToggle }"
                      activeSectionName="{! v.activeSections }"
                  >
                  <table>
                    <tbody>
                      <aura:iteration items="{!v.siteList}" var="a">
                        <tr>
                          <td width="10px">
                              <ui:inputCheckbox aura:id="checkBox" text="{!a.Id}"/>
                          </td>
                          <td>
                            <lightning:accordionSection name="{!a.Name}" label="{!a.Name + ' - ' + a.Membership_Number__c}">
                                <aura:set attribute="body">
                                  <Strong><p>Membership Expiry Date: {!a.Membership_Expiry_Date__c}</p></Strong>
                                  <c:SiteUnits siteId="{!a.Id}"/>
                                </aura:set>
                            </lightning:accordionSection>
                          </td>
                        </tr>
                      </aura:iteration>
                    </tbody>  
                  </table>
                    
                      
                  </lightning:accordion>


                  <!-- Lightning Accordian End-->



                </div>
              </div>
              <div class="slds-form">
                <h3 class="slds-section__title slds-theme_shade">
                  Payment Information
                </h3>
                <div class="slds-form-element slds-form-element_horizontal">
                  <label class="slds-form-element__label">
                    Payment Method
                  </label>
                  <lightning:select
                    name="payMethod"
                    aura:id="field"
                    value="{!v.payMethod}"
                    required="true"
                  >
                    <option label="Please select..."></option>
                    <aura:iteration items="{!v.payMethodValues}" var="item">
                      <option value="{!item.value}">{!item}</option>
                    </aura:iteration>
                  </lightning:select>
                </div>
                <div class="slds-form-element slds-form-element_horizontal">
                  <label class="slds-form-element__label">
                    PO Number
                  </label>
                  <lightning:input
                    name="poNumber"
                    aura:id="field"
                    value="{!v.poNumber}"
                    required="false"
                  />
                </div>

                <h3 class="slds-section__title slds-theme_shade">
                  Legal Information
                </h3>
                <div>
                  <label class="slds-form-element__label">
                    I have read and agreed to the terms of the SCI Certification
                    UK scheme regulations and RSPCA Assured
                    <a
                      class="membershipAgreementLink"
                      href="https://www.berspcaassured.org.uk/media/1038/rspca-assured-membership-agreement-july-2016.pdf"
                      >membership agreement</a
                    >.
                  </label>
                  <lightning:input
                    aura:id="field"
                    type="checkbox"
                    label="Agreement"
                    checked="{!v.agreement}"
                    required="true"
                  />
                </div>
                <br />
                <div>
                  <label class="slds-form-element__label">
                    I confirm that I do not have any previous convictions or
                    pending prosecutions relating to any offence involving the
                    care, handling, transport, slaughter or sale of animals or
                    produce.
                  </label>
                  <lightning:input
                    aura:id="field"
                    type="checkbox"
                    label="No Offences"
                    checked="{!v.noOffences}"
                    required="true"
                  />
                </div>
              </div>
              <!-- Signatory Fields -->
              <div class="slds-form" role="list">
                <div class="slds-form__row">
                  <div class="slds-form__item" role="listitem">
                    <div
                      class="slds-form-element slds-form-element_horizontal slds-is-editing"
                    >
                      <label class="slds-form-element__label">
                        Signatory Contact
                      </label>
                      <div class="slds-form-element__control">
                        <lightning:input
                          type="text"
                          value="{!v.fullname}"
                          readonly="true"
                          messageWhenValueMissing="Please enter a primary contact for the site."
                        />
                      </div>
                    </div>
                  </div>
                  <div class="slds-form__item" role="listitem">
                    <div
                      class="slds-form-element slds-form-element_horizontal slds-is-editing"
                    >
                      <label class="slds-form-element__label">Signed Date</label>
                      <div class="slds-form-element__control">
                        <lightning:input
                          type="date"
                          name="signedDate"
                          disabled="true"
                          value="{!v.agreementDate}"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <aura:set attribute="else"> 
                  <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                      <span class="slds-assistive-text">error</span>
                      <h2>
                          No primary contact found for this site. Please ensure that there is a primary contact available for this head office.
                      </h2>
                  </div>
              </aura:set>
            </aura:if>
          </aura:set>
        </aura:if>
      </aura:if>

      <!-- Step 2 -->
      <aura:if isTrue="{!v.step2}">
        <aura:if isTrue="{!v.payMethod == 'Card'}">
          <div class="slds-form cardPaymentForm">    
              <ui:scrollerWrapper class="addUnitScroll" >
                  <h3 class="slds-section__title slds-theme_shade">
                      Paying by Card
                  </h3>
                  <div class="slds-form-element slds-form-element_horizontal">
                      <label class="slds-form-element__label" for="paymentAmount" id="fixed-text-label">Amount Including VAT @ 20%</label>
                      <div class="slds-form-element__control">
                      <input type="text" id="paymentAmount" value="{! '£' + v.submitResponse.asp04__Amount__c}" readonly="true" class="slds-input" />
                      </div>
                  </div>
                  <iframe src="{!v.submitResponse.Payment_Link__c}" width="500px" height="600px"></iframe>
              </ui:scrollerWrapper>
          </div>
          <aura:set attribute="else">
              <div class="slds-form">
                <h3 class="slds-section__title slds-theme_shade">
                    Paying by BACS or Cheque
                </h3>
                <div class="slds-form-element slds-form-element_horizontal">
                    
                    <label class="slds-form-element__label" id="fixed-text-label">Amount Including VAT @ 20%</label>
                    <div class="slds-form-element__control">
                        <input type="text" id="payAmount" value="{!'£' + v.submitResponse.Total_Amount_Inc_VAT__c}" readonly="true" class="slds-input" />
                    </div>
                </div>
                <div class="slds-form-element slds-form-element_horizontal">
                    <div class="labelWithTooltip">
                        <label class="slds-form-element__label" id="fixed-text-label">Payment Reference</label>
                        <lightning:helptext content="We advise copying the following reference number to easily paste when making a BACS payment."/>
                    </div>
                    
                    <div class="slds-form-element__control">
                        <input type="text" id="payReference" value="{!v.submitResponse.Payment_Reference__c}" readonly="true" class="slds-input" />
                    </div>
                </div>
                <h3 class="referenceHelpMessage">PLEASE USE THIS REFERENCE WHEN PAYING BY BACS</h3>
                <lightning:button variant="brand" label="View Renewal Applications" onclick="{!c.goToBulkRenewal}" />
              </div>

          </aura:set>
        </aura:if>
      </aura:if>
    </ui:scrollerWrapper>
  </div>

  <!-- Modal Footer -->
  <footer
    class="slds-modal__footer slds-grid slds-grid_align-spread footer-fixed"
  >
    <aura:if isTrue="{!v.step1}">
      <lightning:button
        variant="destructive"
        label="Cancel"
        title="Cancel"
        onclick="{!c.handleCancel}"
      />
    </aura:if>
    <lightning:progressIndicator
      currentStep="{!v.currentStep}"
      type="base"
      hasError="{!v.hasError}"
      variant="base"
    >
      <lightning:progressStep label="Step 1" value="1" />
      <lightning:progressStep label="Step 2" value="2" />
    </lightning:progressIndicator>
    <aura:if isTrue="{!v.step1}">
      <aura:if isTrue="{!v.emptyListSize == false}">
        <lightning:button
          variant="brand"
          label="Submit"
          title="Submit"
          onclick="{!c.handleSubmit}"
        />
      </aura:if>
      
    </aura:if>
  </footer>

  <!-- Styling to remove padding from the lightning quick action launch -->
  <aura:html tag="style">
    .cuf-content { padding: 0 0rem !important; } .slds-p-around--medium {
    padding: 0rem !important; } .slds-modal__content{ overflow-y:hidden
    !important; height:unset !important; min-height:300px; max-height:unset
    !important; position: relative; padding-bottom: 4em; }
    .slds-modal__container { max-width: 70rem !important; } .slds-modal__footer
    { position: absolute; bottom:0; left:0; right:0; z-index: 2; }
    .slds-spinner_container{ position:inherit !important; }
  </aura:html>
</aura:component>